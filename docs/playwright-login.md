# Playwright Login Service\n\n## Zweck\nDer `playwright-login`-Dienst ist ein spezialisierter Microservice, der dafür verantwortlich ist, sich bei externen Providern (aktuell `freelance.de`) via Playwright anzumelden und gültige Session-Cookies zu extrahieren. Diese Cookies werden dann von anderen Diensten (insbesondere `crawl4ai`) verwendet, um auf geschützte Bereiche der jeweiligen Provider-Websites zugreifen zu können.\n\n## Architektur & Workflow\n\n1.  **Anfrage von einem Client (z.B. `crawl4ai`):**\n    *   Endpunkt: `POST /login-by-user-id`\n    *   Body: `{ "user_id": <ID des Benutzers> }`\n    *   Der Client (z.B. `crawl4ai`) sendet die User-ID an diesen Endpunkt, wenn er neue Cookies benötigt.\n\n2.  **Abruf der Credentials vom Backend:**\n    *   Der `playwright-login`-Dienst empfängt die `user_id`.\n    *   Er stellt eine `GET`-Anfrage an das Django-Backend: `http://backend:8000/api/v1/freelance/credentials/<user_id>/`.\n    *   Wichtig ist hierbei der Header `X-Playwright-Login-Service: true`. Dieser signalisiert dem Backend, dass es die Login-URL, den Benutzernamen und das **entschlüsselte** Passwort des Benutzers zurückgeben soll.\n    *   Das Backend holt die verschlüsselten Daten aus der Datenbank, entschlüsselt das Passwort und sendet die Informationen zurück.\n\n3.  **Playwright Login-Prozess:**\n    *   Mit den erhaltenen Credentials (Username, entschlüsseltes Passwort, Login-URL) startet der Dienst eine headless Playwright (Chromium) Instanz.\n    *   Er navigiert zur spezifischen Login-Seite des Providers (z.B. `link_1` aus den Credentials für `freelance.de`).\n    *   Füllt die Login-Formularfelder aus.\n    *   Behandelt ggf. Cookie-Banner.\n    *   Klickt auf den Login-Button.\n    *   Wartet, bis die Seite geladen ist und extrahiert die Session-Cookies.\n\n4.  **Antwort an den Client:**\n    *   Bei Erfolg: `{ "success": true, "cookies": [...] }`\n    *   Bei Fehler: `{ "success": false, "error": "..." }`\n\n## Endpunkte\n\n### `POST /login-by-user-id`\n-   **Zweck:** Hauptendpunkt für das Abrufen von Cookies basierend auf einer User-ID.\n-   **Request Body:**\n    ```json\n    {\n      "user_id": 123\n    }\n    ```\n-   **Antwort bei Erfolg (200 OK):**\n    ```json\n    {\n      "success": true,\n      "cookies": [ { "name": "...": "value": "...", ... } ]\n    }\n    ```\n-   **Antwort bei Fehler (4xx/5xx):**\n    ```json\n    {\n      "success": false,\n      "error": "Fehlermeldung",\n      "details": { ... } // Optionale Fehlerdetails vom Backend\n    }\n    ```\n\n### `POST /login/:provider` (Legacy/Direkt)\n-   **Zweck:** Ermöglicht einen direkten Login mit Username und Passwort. Wird aktuell nicht vom `crawl4ai`-Service genutzt, bleibt aber für Tests oder andere Anwendungsfälle erhalten.\n-   **URL Parameter:** `provider` (z.B. `freelance.de`)\n-   **Request Body:**\n    ```json\n    {\n      "username": "testuser",\n      "password": "testpass",\n      "login_url": "https://optional.login.url/path" // Optional\n    }\n    ```\n-   **Antwort:** Ähnlich wie bei `/login-by-user-id`.\n\n## Konfiguration & Abhängigkeiten\n-   **Docker Image:** Basiert auf Node.js und installiert Playwright.\n-   **Netzwerk:** Muss im selben Docker-Netzwerk wie das Backend (`mailmind-dev-network`) laufen, um auf dessen API zugreifen zu können.\n-   **Volumes:** Nutzt ein Volume (`crawl4ai_cookies`), das mit dem `crawl4ai`-Dienst geteilt wird, um Cookies persistent zu speichern und zwischenzuspeichern. (Hinweis: Das direkte Speichern und Lesen von Cookies aus dem Volume durch den `playwright-login`-Dienst ist *nicht* mehr Teil des primären Flows mit `/login-by-user-id`, `crawl4ai` ist für das Cookie-Management im Volume zuständig).\n-   **Umgebungsvariablen:**\n    *   `EMAIL_ACCOUNT_ENCRYPTION_KEY`: *Nicht mehr direkt benötigt*, da entschlüsselte Passwörter vom Backend kommen.\n    *   `DJANGO_SECRET_KEY`: *Nicht mehr direkt benötigt* für die Authentifizierung gegenüber dem Backend im aktuellen Setup (wird aber für robustere Auth-Methoden in Zukunft nützlich sein).\n
## Sicherheitsüberlegungen\n-   Die Kommunikation zwischen `playwright-login` und dem Backend für den Credential-Abruf ist aktuell nur durch das Docker-Netzwerk und den `X-Playwright-Login-Service`-Header gesichert. Dies sollte langfristig durch eine stärkere Service-zu-Service-Authentifizierung (z.B. API-Key/Token) ersetzt werden.\n-   Das Backend gibt entschlüsselte Passwörter nur an diesen Dienst weiter, wenn der spezielle Header vorhanden ist.\n\n## Starten des Dienstes\nDer Dienst wird über `docker-compose.dev.yml` als Teil des Entwicklungs-Stacks gestartet.\n
## Persistente Sessions & Browser-Lifecycle

Ab Mai 2024 wird der Playwright-Login-Service so erweitert, dass pro User ein Browser/Context dauerhaft offen bleibt und für alle Requests genutzt wird. Das bedeutet:

- **Ein Login pro User/Session:** Nach erfolgreichem Login bleibt der Browser/Context für den User offen.
- **Wiederverwendung:** Alle Requests (z.B. `/fetch-protected-page`, `/crawl-session`) nutzen die bestehende Session, solange sie gültig ist.
- **Kein erneuter Login/Brower-Neustart:** Erst wenn die Session abläuft oder explizit beendet wird, erfolgt ein neuer Login.
- **Speicherung:** Sessiondaten (Cookies, LocalStorage, SessionStorage) werden regelmäßig gespeichert und können bei Neustart wiederhergestellt werden.

### Neue/angepasste Endpunkte
- `POST /crawl-session`: Lädt mehrere Seiten im selben Browser-Kontext, prüft Login-Status, loggt ggf. ein, gibt HTMLs gesammelt zurück.
- `POST /fetch-protected-page`: Lädt eine beliebige URL im bestehenden User-Context.
- (Geplant) `POST /close-session`: Beendet explizit die User-Session und schließt den Browser/Context.

### Hinweise
- Pro User existiert maximal ein aktiver Browser/Context.
- Die Session bleibt so lange offen, bis sie explizit geschlossen oder als ungültig erkannt wird (z.B. Logout, Timeout, Fehler).
- Nach einem Service-Restart werden Sessiondaten aus dem Volume geladen und die Session kann ggf. fortgesetzt werden.
- Ziel: Maximale Performance und minimale Logins, keine Promo-Redirects oder Session-Verluste mehr.

**Letztes Update:** Mai 2024 