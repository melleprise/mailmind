# Mapping: IMAP Tools MailMessage -> Django Email Model

Dieses Dokument beschreibt, wie die Attribute eines `imap_tools.MailMessage`-Objekts (im Code typischerweise als `msg` referenziert) auf die Felder des Django `Email`-Modells (`backend/mailmind/core/models.py`) abgebildet werden. Die Verarbeitung findet hauptsächlich in der Funktion `process_new_email` in `backend/mailmind/imap/utils.py` statt.

**Ziel:** Die Struktur des Django-Modells wird beibehalten. Die Anpassung erfolgt in der Verarbeitungslogik, nicht durch Änderung des Datenbank-Schemas.

| `imap_tools` Attribut (`msg.`) | Django `Email` Feld                     | Verarbeitung / Hinweise in `process_new_email`                                                                                                                                                |
| :----------------------------- | :-------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `message_id` (aus Header)    | `message_id` (CharField)                | Wird als Primärschlüssel (zusammen mit `account`) für `update_or_create` verwendet. Muss zuvor aus `msg.headers.get('message-id')` extrahiert und bereinigt werden (`strip('<>')`).            |
| `uid`                          | `uid` (CharField)                       | Direkte Zuweisung im `defaults`-Dictionary von `update_or_create`.                                                                                                                            |
| `subject`                      | `subject` (CharField)                   | Direkte Zuweisung im `defaults`-Dictionary. `None` wird als Leerstring (`''`) behandelt: `msg.subject or ''`.                                                                                  |
| `date` (datetime)              | `sent_at` (DateTimeField)               | Direkte Zuweisung zum Feld `sent_at` im `defaults`-Dictionary. Repräsentiert den `Date:`-Header.                                                                                              |
| `date_str` (string)            | `date_str` (CharField)                  | Direkte Zuweisung im `defaults`-Dictionary.                                                                                                                                                   |
| `from_values` (MailAddress)    | `from_address` (EmailField)             | Im `defaults`-Dictionary: `defaults['from_address'] = msg.from_values.email if msg.from_values else ''`.                                                                                       |
| `from_values` (MailAddress)    | `from_name` (CharField)                 | Im `defaults`-Dictionary: `defaults['from_name'] = msg.from_values.name if msg.from_values else ''`.                                                                                           |
| `from_values` (MailAddress)    | `from_contact` (ForeignKey `Contact`)   | **Nach** `update_or_create`: `Contact.objects.get_or_create(email=msg.from_values.email, defaults={'name': msg.from_values.name})`. Das `Contact`-Objekt wird `email_instance.from_contact` zugewiesen und gespeichert. |
| `to_values` (List[MailAddress])| `to_contacts` (ManyToManyField `Contact`) | **Nach** `update_or_create`: Iteriere durch `msg.to_values`. Für jede Adresse (`addr`): `Contact.objects.get_or_create(email=addr.email, defaults={'name': addr.name})`. Füge den Kontakt zu `email_instance.to_contacts` hinzu (`add()`). |
| `cc_values` (List[MailAddress])| `cc_contacts` (ManyToManyField `Contact`) | **Nach** `update_or_create`: Analog zu `to_values`, aber für `email_instance.cc_contacts`.                                                                                                   |
| `bcc_values` (List[MailAddress])| `bcc_contacts` (ManyToManyField `Contact`) | **Nach** `update_or_create`: Analog zu `to_values`, aber für `email_instance.bcc_contacts`.                                                                                                  |
| `reply_to_values` (List[MailAddress])| `reply_to_contacts` (ManyToManyField `Contact`) | **Nach** `update_or_create`: Analog zu `to_values`, aber für `email_instance.reply_to_contacts`.                                                                                            |
| `text` (str)                   | `body_text` (TextField)                 | Direkte Zuweisung im `defaults`-Dictionary: `defaults['body_text'] = msg.text or ''`.                                                                                                          |
| `html` (str)                   | `body_html` (TextField)                 | Direkte Zuweisung im `defaults`-Dictionary: `defaults['body_html'] = msg.html or ''`.                                                                                                          |
| `flags` (Tuple[str]/Set[str])  | `is_read` (BooleanField)                | Im `defaults`-Dictionary: `defaults['is_read'] = ('\\Seen' in msg.flags)`.                                                                                                                  |
| `flags` (Tuple[str]/Set[str])  | `is_flagged` (BooleanField)             | Im `defaults`-Dictionary: `defaults['is_flagged'] = ('\\Flagged' in msg.flags)`.                                                                                                             |
| `flags` (Tuple[str]/Set[str])  | `is_replied` (BooleanField)             | Im `defaults`-Dictionary: `defaults['is_replied'] = ('\\Answered' in msg.flags)`.                                                                                                            |
| `flags` (Tuple[str]/Set[str])  | `is_deleted_on_server` (BooleanField)   | Im `defaults`-Dictionary: `defaults['is_deleted_on_server'] = ('\\Deleted' in msg.flags)`.                                                                                                  |
| `flags` (Tuple[str]/Set[str])  | `is_draft` (BooleanField)               | Im `defaults`-Dictionary: `defaults['is_draft'] = ('\\Draft' in msg.flags)`.                                                                                                                |
| `headers` (dict)               | `headers` (JSONField)                   | Direkte Zuweisung im `defaults`-Dictionary: `defaults['headers'] = dict(msg.headers) if msg.headers else {}`.                                                                                  |
| `size_rfc822` (int)            | `size_rfc822` (PositiveIntegerField)    | Direkte Zuweisung im `defaults`-Dictionary.                                                                                                                                                   |
| `size` (int)                   | `size` (PositiveIntegerField)           | Direkte Zuweisung im `defaults`-Dictionary.                                                                                                                                                   |
| *(Kein direktes Feld)*         | `received_at` (DateTimeField)           | Wird aktuell **nicht** explizit gesetzt. Könnte im `defaults`-Dictionary auf `timezone.now()` gesetzt werden, falls `created` (von `update_or_create`) `True` ist.                          |
| *(Kein direktes Feld)*         | `conversation_id` (CharField)           | Wird aktuell **nicht** gesetzt. Benötigt separate Logik zur Extraktion relevanter Header (`References`, `In-Reply-To`, `Thread-Index`) und zur Gruppierung.                                    |
| `account_id` (Parameter)       | `account` (ForeignKey `EmailAccount`)   | Das `EmailAccount`-Objekt wird vor dem `update_or_create`-Aufruf per `account_id` geholt und direkt an `update_or_create(account=account, ...)` übergeben.                                   |
| `msg.obj` (email.message.Message)| `attachments` (Related `Attachment`)    | Das `msg.obj` wird nach `update_or_create` an die Funktion `process_attachments(msg.obj, email_instance)` übergeben. Diese erstellt `Attachment`-Objekte und verknüpft sie mit `email_instance`. |

**Wichtige Hinweise:**

*   Die Verarbeitung der ManyToMany-Felder (`to_contacts`, `cc_contacts` etc.) und des ForeignKey `from_contact` muss **nach** dem Speichern der `Email`-Instanz durch `update_or_create` erfolgen.
*   Die Logik zum Suchen oder Erstellen von `Contact`-Objekten (`get_or_create`) ist entscheidend, um Duplikate zu vermeiden.
*   Die Felder `received_at` und `conversation_id` benötigen ggf. noch zusätzliche Logik, falls sie benötigt werden. 